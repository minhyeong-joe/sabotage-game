document.addEventListener("DOMContentLoaded",()=>{const hash=new Hashes.SHA256,loader=document.getElementById("loader"),chatForm=document.getElementById("message-form"),chatWindow=document.querySelector(".chat-area"),topicSelect=document.getElementById("topic-select"),startGameBtn=document.getElementById("start-game-btn"),readyToVoteBtn=document.getElementById("ready-to-vote-btn"),sabotageBtn=document.getElementById("sabotage-btn"),voteBtn=document.getElementById("vote-btn"),challengeBtn=document.getElementById("challenge-btn"),messageInput=document.getElementById("messageInput"),messageSendBtn=document.getElementById("message-send-btn"),charCount=document.getElementById("current-character-count"),spamPrevention=document.getElementById("spam-prevention"),voteTimer=document.getElementById("vote-timer"),sabotageTimer=document.getElementById("sabotage-timer"),volumeControl=document.getElementById("volume"),messageInputHeight=messageInput.style.height,urlParams=new URLSearchParams(window.location.search),roomName=urlParams.get("room"),username=sessionStorage.getItem("username"),color=sessionStorage.getItem("color"),font=sessionStorage.getItem("font");messageInput.style.fontFamily=font;const challenge=hash.hex(username);let sendCooldown=0,cdInterval;const VOTE_TIME_LIMIT=10,SABOTAGE_TIME_LIMIT=20;let isHost=!1,isSpy=!1,isAlive=!1,numUsers,voteTime=0,sabotageTime=0,voteInterval,voteTimeout,sabotageInterval,sabotageTimeout,volume=1;const notification=new Audio("../assets/notification.wav"),startSound=new Audio("../assets/start.wav"),timerSound=new Audio("../assets/clock.wav"),gunshotSound=new Audio("../assets/gunshot.wav"),spyWinSound=new Audio("../assets/spy_wins.wav"),agentWinSound=new Audio("../assets/agents_win.wav");if(!username||challenge!=sessionStorage.getItem("token"))return void window.location.replace("/");const socket=io();socket.on("connect",()=>{socket.on("roomExists",roomExists=>{roomExists||window.location.replace("/public")}),socket.emit("joinRoom",{username:username,room:roomName,color:color}),socket.on("roomUsers",({room:room,users:users})=>{renderRoomName(room),renderUserList(users),numUsers=users.length,users[0].id==socket.id&&(isHost=!0)}),$("body").removeClass("loading"),loader.classList.remove("loading"),socket.on("topicChange",topic=>{topicSelect.value=topic}),socket.on("gameStart",game=>{spyWinSound.pause(),agentWinSound.pause(),startSound.currentTime=0,startSound.volume=volume,startSound.play(),chatWindow.innerHTML="",renderChatMessage(socket.id,{id:null,username:"ChatBot",message:"The Game has started!",time:(new Date).toLocaleTimeString()}),$("#game-rule-modal").modal("hide"),document.querySelector(".game-start-container").classList.add("d-none"),document.querySelector(".list-of-words-toggle").classList.remove("d-none"),document.getElementById("ready-to-vote-btn").removeAttribute("disabled"),document.querySelector(".list-group").innerHTML=`\n            ${game.list.map(option=>`<li class="list-group-item">${option}</li>`).join("")}\n            `,document.getElementById("sabotage-select").innerHTML=`\n            ${game.list.map(option=>`<option value="${option}">${option}</option>`).join("")}\n            `,"spy"==game.role?(document.querySelector(".spy-view").classList.remove("d-none"),document.getElementById("sabotage-btn").removeAttribute("disabled"),isSpy=!0):(document.getElementById("answer-word").innerText=game.word,document.querySelector(".agent-view").classList.remove("d-none")),isAlive=!0}),socket.on("vote",survived=>{sabotageBtn.setAttribute("disabled",!0);const voteSelect=document.getElementById("vote-select");voteSelect.innerHTML='<option value="skip">Skip Vote</option>',voteSelect.innerHTML+=`\n                ${survived.map(surv=>`<option value="${surv.id}">${surv.username}</option>`).join("")}\n            `,$("#game-rule-modal").modal("hide"),$("#vote-modal").modal({backdrop:"static",keyboard:!1}),timerSound.currentTime=0,timerSound.volume=volume,timerSound.play(),voteTime=10,voteTimer.innerText=voteTime,voteInterval=setInterval(()=>{voteTime--,voteTimer.innerText=voteTime},1e3),voteTimeout=setTimeout(()=>{clearInterval(voteInterval),socket.emit("vote","skip"),$("#vote-modal").modal("hide")},1e4)}),socket.on("voteDone",deadId=>{timerSound.pause(),deadId&&(gunshotSound.currentTime=0,gunshotSound.volume=volume,gunshotSound.play()),deadId==socket.id?(isAlive=!1,document.querySelector(".agent-view").classList.add("d-none"),document.querySelector(".dead-view").classList.remove("d-none"),readyToVoteBtn.setAttribute("disabled",!0),sabotageBtn.setAttribute("disabled",!0)):(readyToVoteBtn.removeAttribute("disabled"),isSpy&&sabotageBtn.removeAttribute("disabled"))}),socket.on("sabotage",()=>{readyToVoteBtn.setAttribute("disabled",!0),sabotageBtn.setAttribute("disabled",!0),isSpy&&($("#game-rule-modal").modal("hide"),$("#sabotage-modal").modal({backdrop:"static",keyboard:!1}),timerSound.currentTime=0,timerSound.volume=volume,timerSound.play(),sabotageTime=20,sabotageTimer.innerText=sabotageTime,sabotageInterval=setInterval(()=>{sabotageTime--,sabotageTimer.innerText=sabotageTime},1e3),sabotageTimeout=setTimeout(()=>{clearInterval(sabotageInterval);const guess=document.getElementById("sabotage-select").value;socket.emit("guess",guess),$("#sabotage-modal").modal("hide")},2e4))}),socket.on("endGame",winner=>{timerSound.pause(),document.querySelector(".game-start-container").classList.remove("d-none"),document.querySelector(".list-of-words-toggle").classList.add("d-none"),$("#list-of-words").collapse("hide"),document.getElementById("sabotage-btn").setAttribute("disabled",!0),document.getElementById("ready-to-vote-btn").setAttribute("disabled",!0),document.querySelector(".spy-view").classList.add("d-none"),document.getElementById("answer-word").innerText="",document.querySelector(".agent-view").classList.add("d-none"),document.querySelector(".dead-view").classList.add("d-none"),$("#vote-modal").modal("hide"),$("#sabotage-modal").modal("hide"),$("#game-rule-modal").modal("hide"),clearInterval(voteInterval),clearInterval(sabotageInterval),clearTimeout(voteTimeout),clearTimeout(sabotageTimeout),timerSound.pause(),voteTime=0,sabotageTime=0,isSpy=!1,isAlive=!1,"agents"==winner?(agentWinSound.currentTime=0,agentWinSound.volume=volume,agentWinSound.play()):(spyWinSound.currentTime=0,spyWinSound.volume=volume,spyWinSound.play())}),socket.on("message",data=>{renderChatMessage(socket.id,data),chatWindow.scrollTop=chatWindow.scrollHeight})}),chatForm.addEventListener("submit",e=>{e.preventDefault(),messageInput.style.height=messageInputHeight;const msg=e.target.elements.messageInput.value;if(""!=msg){if(sendCooldown>0)return spamPrevention.innerText=`You have to wait ${sendCooldown} seconds for next message.`,spamPrevention.classList.remove("hide"),void setTimeout(()=>{spamPrevention.classList.add("hide")},1e3);clearInterval(cdInterval),sendCoolDown=0,socket.emit("chatMessage",msg),e.target.elements.messageInput.value="",charCount.innerText=0,e.target.elements.messageInput.focus(),messageSendBtn.setAttribute("disabled",!0),sendCooldown=2,cdInterval=setInterval(()=>{sendCooldown--},1e3)}}),messageInput.addEventListener("input",e=>{""==e.target.value?messageSendBtn.setAttribute("disabled",!0):messageSendBtn.removeAttribute("disabled"),charCount.innerText=e.target.value.length}),messageInput.addEventListener("keypress",e=>{13==e.which&&(e.preventDefault(),messageSendBtn.click(),messageInput.style.height=messageInputHeight)}),topicSelect.addEventListener("change",e=>{if(!isHost)return void e.preventDefault();const selectedTopic=e.target.value;socket.emit("topicChange",selectedTopic)}),startGameBtn.addEventListener("click",()=>{if(isHost)return numUsers<3?($(".not-enough").slideDown(),void setTimeout(()=>{$(".not-enough").slideUp()},1500)):void socket.emit("gameStart",topicSelect.value)}),readyToVoteBtn.addEventListener("click",()=>{isAlive&&(socket.emit("readyToVote"),readyToVoteBtn.setAttribute("disabled",!0))}),voteBtn.addEventListener("click",()=>{if(clearTimeout(voteTimeout),clearInterval(voteInterval),voteTime=0,!isAlive)return;const voted=document.getElementById("vote-select").value;socket.emit("vote",voted),$("#vote-modal").modal("hide")}),sabotageBtn.addEventListener("click",()=>{isAlive&&isSpy&&socket.emit("sabotage")}),challengeBtn.addEventListener("click",()=>{if(isSpy){clearTimeout(sabotageTimeout),clearInterval(sabotageInterval),sabotageTime=0;const guess=document.getElementById("sabotage-select").value;socket.emit("guess",guess),$("#sabotage-modal").modal("hide")}}),autosize(document.querySelector("textarea")),volumeControl.addEventListener("change",e=>{volume=e.target.value});const renderChatMessage=(sessionId,data)=>{const div=document.createElement("div");div.classList.add("message"),div.innerHTML="",null==data.userId?div.classList.add("system-message"):data.userId==sessionId?(div.classList.add("my-message"),div.style.backgroundColor=data.color,div.innerHTML+=`<div class="username" style="font-family: ${font}">\n                                ${data.username}\n                            </div>`,notification.currentTime=0,notification.play()):(div.style.backgroundColor=data.color,div.innerHTML+=`<div class="username" style="font-family: ${font}">\n                                ${data.username}\n                            </div>`,notification.currentTime=0,notification.play()),div.innerHTML+=`<div class="content" style="font-family: ${font}">\n                            ${data.message}\n                        </div>\n                        <div class="timestamp" style="font-family: ${font}">\n                            ${data.time}\n                        </div>`,chatWindow.append(div)},renderRoomName=room=>{document.getElementById("room-name").innerText=room},renderUserList=users=>{users[0].username==username&&(topicSelect.removeAttribute("disabled"),startGameBtn.removeAttribute("disabled")),document.getElementById("user-list").innerHTML=`\n            ${users.map(user=>`<li>${user.username}</li>`).join("")}\n        `}});