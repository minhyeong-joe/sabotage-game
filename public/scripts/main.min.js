document.addEventListener("DOMContentLoaded",()=>{sessionStorage.removeItem("room-token");const hash=new Hashes.SHA256,loader=document.getElementById("loader"),chatForm=document.getElementById("message-form"),chatWindow=document.querySelector(".chat-area"),createRoomBtn=document.getElementById("create-room-btn"),createRoomForm=document.getElementById("create-room-form"),messageInput=document.getElementById("messageInput"),messageSendBtn=document.getElementById("message-send-btn"),charCount=document.getElementById("current-character-count"),spamPrevention=document.getElementById("spam-prevention"),autoscrollSwitch=document.getElementById("autoscroll-switch"),messageInputHeight=messageInput.style.height,username=sessionStorage.getItem("username"),color=sessionStorage.getItem("color"),font=sessionStorage.getItem("font");messageInput.style.fontFamily=font;const challenge=hash.hex(username);let sendCooldown=0,cdInterval,isAutoscroll=!0;const notification=new Audio("../assets/notification.wav");if(!username||challenge!=sessionStorage.getItem("token"))return void window.location.replace("/");const socket=io();socket.on("connect",()=>{const sessionId=socket.id;socket.emit("joinRoom",{username:username,room:"Public Area",color:color}),socket.on("roomUsers",({room:room,users:users})=>{renderRoomName(room),renderUserList(users)}),$("body").removeClass("loading"),loader.classList.remove("loading"),socket.on("roomsChange",rooms=>{renderRooms(rooms)}),socket.on("duplicateRoomName",()=>{document.getElementById("error-feedback").classList.remove("d-none"),document.getElementById("create-btn").setAttribute("disabled",!0)}),socket.on("roomCreated",newRoom=>{$("#create-room-modal").modal("hide"),sessionStorage.setItem("room-token",hash.hex(newRoom.name)),window.location.href=`/chatroom?room=${newRoom.name}`}),socket.on("roomAccess",({valid:valid,room:room})=>{valid?(sessionStorage.setItem("room-token",hash.hex(room.name)),window.location.href=`/chatroom?room=${room.name}`):(document.getElementById("wrong-password").classList.remove("d-none"),document.getElementById("enter-btn").setAttribute("disabled",!0))}),socket.on("message",data=>{renderChatMessage(sessionId,data),isAutoscroll&&(chatWindow.scrollTop=chatWindow.scrollHeight)})}),chatForm.addEventListener("submit",e=>{e.preventDefault(),messageInput.style.height=messageInputHeight;const msg=e.target.elements.messageInput.value;if(""!=msg){if(sendCooldown>0)return spamPrevention.innerText=`You have to wait ${sendCooldown} seconds for next message.`,spamPrevention.classList.remove("hide"),void setTimeout(()=>{spamPrevention.classList.add("hide")},1e3);clearInterval(cdInterval),sendCoolDown=0,socket.emit("chatMessage",msg),e.target.elements.messageInput.value="",charCount.innerText=0,e.target.elements.messageInput.focus(),messageSendBtn.setAttribute("disabled",!0),sendCooldown=2,cdInterval=setInterval(()=>{sendCooldown--},1e3)}}),messageInput.addEventListener("input",e=>{""==e.target.value?messageSendBtn.setAttribute("disabled",!0):messageSendBtn.removeAttribute("disabled"),charCount.innerText=e.target.value.length}),messageInput.addEventListener("keypress",e=>{13==e.which&&(e.preventDefault(),messageSendBtn.click(),messageInput.style.height=messageInputHeight)}),autoscrollSwitch.addEventListener("change",()=>{isAutoscroll=autoscrollSwitch.checked,autoscrollSwitch.checked&&(chatWindow.scrollTop=chatWindow.scrollHeight)}),createRoomBtn.addEventListener("click",e=>{e.preventDefault(),$("#create-room-modal").modal()}),createRoomForm.addEventListener("submit",e=>{e.preventDefault();const roomName=e.target.elements["room-name-input"].value,password=e.target.elements["password-input"].value;""!=roomName&&roomName.length<=10&&socket.emit("createRoom",{roomName:roomName,password:password})}),document.getElementById("room-name-input").addEventListener("input",()=>{document.getElementById("error-feedback").classList.add("d-none"),document.getElementById("create-btn").removeAttribute("disabled")}),$("body").on("click","a.room-link",e=>{e.preventDefault();const clickedRoomName=e.target.dataset.roomname,hasPassword="true"==e.target.dataset.password;hasPassword?($("#password-modal").modal("show"),$("#roomName").val(clickedRoomName)):(sessionStorage.setItem("room-token",hash.hex(clickedRoomName)),window.location.href=`/chatroom?room=${clickedRoomName}`)}),$("#enter-password-form").on("submit",e=>{e.preventDefault();const roomName=e.target.elements.roomName.value,password=e.target.elements.password.value;console.log(roomName,password),socket.emit("matchPassword",{roomName:roomName,password:password})}),document.getElementById("password").addEventListener("input",()=>{document.getElementById("wrong-password").classList.add("d-none"),document.getElementById("enter-btn").removeAttribute("disabled")}),autosize(document.querySelector("textarea"));const renderChatMessage=(sessionId,data)=>{const div=document.createElement("div");div.classList.add("message"),div.innerHTML="",null==data.userId?div.classList.add("system-message"):data.userId==sessionId?(div.classList.add("my-message"),div.style.backgroundColor=data.color,div.innerHTML+=`<div class="username" style="font-family: ${font}">\n                                ${data.username}\n                            </div>`,notification.currentTime=0,notification.play()):(div.style.backgroundColor=data.color,div.innerHTML+=`<div class="username" style="font-family: ${font}">\n                                ${data.username}\n                            </div>`,notification.currentTime=0,notification.play()),div.innerHTML+=`<div class="content" style="font-family: ${font}">\n                            ${data.message}\n                        </div>\n                        <div class="timestamp" style="font-family: ${font}">\n                            ${data.time}\n                        </div>`,chatWindow.append(div)},renderRoomName=room=>{document.getElementById("room-name").innerText=room},renderUserList=users=>{document.getElementById("user-list").innerHTML=`\n            ${users.map(user=>`<li>${user.username}</li>`).join("")}\n        `},renderRooms=rooms=>{document.getElementById("room-list").innerHTML=`\n            ${rooms.map(room=>`<a data-roomname="${room.name}" href="/chatroom?room=${room.name}" class="room-link ${room.numUsers>=10||room.isPlaying?"disabled":""}">\n                    <li data-roomname="${room.name}" data-password="${!!room.password}">\n                        ${room.password?"<i class='fas fa-lock'></i> ":""}\n                        ${room.name} (${room.numUsers}/10)\n                    </li>\n                </a>`).join("")}\n        `}});